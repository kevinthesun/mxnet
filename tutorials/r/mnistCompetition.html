<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Handwritten Digits Classification Competition — mxnet  documentation</title>
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" rel="stylesheet"/>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../_static/basic.css" rel="stylesheet" type="text/css">
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../_static/mxnet.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: ''
      };
    </script>
<script src="../../_static/jquery-1.11.1.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/searchtools_custom.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<script src="../../_static/selectlang.js" type="text/javascript"></script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script type="text/javascript"> jQuery(function() { Search.loadIndex("/searchindex.js"); Search.init();}); </script>
<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
      Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-96378503-1', 'auto');
      ga('send', 'pageview');

    </script>
<!-- -->
<!-- <script type="text/javascript" src="../../_static/jquery.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/underscore.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/doctools.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<!-- -->
<link href="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet-icon.png" rel="icon" type="image/png"/>
</link></link></head>
<body role="document"><!-- Previous Navbar Layout
<div class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="../../" class="navbar-brand">
        <img src="http://data.mxnet.io/theme/mxnet.png">
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul id="navbar" class="navbar navbar-left">
        
        <li> <a href="../../get_started/index.html">Get Started</a> </li>
        
        <li> <a href="../../tutorials/index.html">Tutorials</a> </li>
        
        <li> <a href="../../how_to/index.html">How To</a> </li>
        
        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">Packages <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../../packages/python/index.html">
                Python
            </a></li>
            
            <li><a href="../../packages/r/index.html">
                R
            </a></li>
            
            <li><a href="../../packages/julia/index.html">
                Julia
            </a></li>
            
            <li><a href="../../packages/c++/index.html">
                C++
            </a></li>
            
            <li><a href="../../packages/scala/index.html">
                Scala
            </a></li>
            
            <li><a href="../../packages/perl/index.html">
                Perl
            </a></li>
            
          </ul>
        </li>
        
        <li> <a href="../../system/index.html">System</a> </li>
        <li> 
<form class="" role="search" action="../../search.html" method="get" autocomplete="off">
  <div class="form-group inner-addon left-addon">
    <i class="glyphicon glyphicon-search"></i>
    <input type="text" name="q" class="form-control" placeholder="Search">
  </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  
</form> </li>
      </ul>
      <ul id="navbar" class="navbar navbar-right">
        <li> <a href="../../index.html"><span class="flag-icon flag-icon-us"></span></a> </li>
        <li> <a href="../..//zh/index.html"><span class="flag-icon flag-icon-cn"></span></a> </li>
      </ul>
    </div>
  </div>
</div>
Previous Navbar Layout End -->
<div class="navbar navbar-fixed-top">
<div class="container" id="navContainer">
<div class="innder" id="header-inner">
<h1 id="logo-wrap">
<a href="../../" id="logo"><img src="http://data.mxnet.io/theme/mxnet.png"/></a>
</h1>
<nav class="nav-bar" id="main-nav">
<a class="main-nav-link" href="../../get_started/install.html">Install</a>
<a class="main-nav-link" href="../../tutorials/index.html">Tutorials</a>
<a class="main-nav-link" href="../../how_to/index.html">How To</a>
<span id="dropdown-menu-position-anchor">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">API <span class="caret"></span></a>
<ul class="dropdown-menu" id="package-dropdown-menu">
<li><a class="main-nav-link" href="../../api/python/index.html">Python</a></li>
<li><a class="main-nav-link" href="../../api/scala/index.html">Scala</a></li>
<li><a class="main-nav-link" href="../../api/r/index.html">R</a></li>
<li><a class="main-nav-link" href="../../api/julia/index.html">Julia</a></li>
<li><a class="main-nav-link" href="../../api/c++/index.html">C++</a></li>
<li><a class="main-nav-link" href="../../api/perl/index.html">Perl</a></li>
</ul>
</span>
<a class="main-nav-link" href="../../architecture/index.html">Architecture</a>
<!-- <a class="main-nav-link" href="../../community/index.html">Community</a> -->
<a class="main-nav-link" href="https://github.com/dmlc/mxnet">Github</a>
<span id="dropdown-menu-position-anchor-version" style="position: relative"><a href="#" class="main-nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">Versions(v0.22.0test)<span class="caret"></span></a><ul id="package-dropdown-menu" class="dropdown-menu"><li><a class="main-nav-link" href=http://localhost:8008/>v0.22.0test</a></li><li><a class="main-nav-link" href=http://localhost:8008/versions/v0.19.0test/index.html>v0.19.0test</a></li><li><a class="main-nav-link" href=http://localhost:8008/versions/0.10/index.html>0.10</a></li><li><a class="main-nav-link" href=http://localhost:8008/versions/master/index.html>master</a></li></ul></span></nav>
<script> function getRootPath(){ return "../../" } </script>
<div class="burgerIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">☰</a>
<ul class="dropdown-menu dropdown-menu-right" id="burgerMenu">
<li><a href="../../get_started/install.html">Install</a></li>
<li><a href="../../tutorials/index.html">Tutorials</a></li>
<li><a href="../../how_to/index.html">How To</a></li>
<li class="dropdown-submenu">
<a href="#" tabindex="-1">API</a>
<ul class="dropdown-menu">
<li><a href="../../api/python/index.html" tabindex="-1">Python</a>
</li>
<li><a href="../../api/scala/index.html" tabindex="-1">Scala</a>
</li>
<li><a href="../../api/r/index.html" tabindex="-1">R</a>
</li>
<li><a href="../../api/julia/index.html" tabindex="-1">Julia</a>
</li>
<li><a href="../../api/c++/index.html" tabindex="-1">C++</a>
</li>
<li><a href="../../api/perl/index.html" tabindex="-1">Perl</a>
</li>
</ul>
</li>
<li><a href="../../architecture/index.html">Architecture</a></li>
<li><a class="main-nav-link" href="https://github.com/dmlc/mxnet">Github</a></li>
<li id="dropdown-menu-position-anchor-version-mobile" class="dropdown-submenu" style="position: relative"><a href="#" tabindex="-1">Versions(v0.22.0test)</a><ul class="dropdown-menu"><li><a tabindex="-1" href=http://localhost:8008/>v0.22.0test</a></li><li><a tabindex="-1" href=http://localhost:8008/versions/v0.19.0test/index.html>v0.19.0test</a></li><li><a tabindex="-1" href=http://localhost:8008/versions/0.10/index.html>0.10</a></li><li><a tabindex="-1" href=http://localhost:8008/versions/master/index.html>master</a></li></ul></li></ul>
</div>
<div class="plusIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button"><span aria-hidden="true" class="glyphicon glyphicon-plus"></span></a>
<ul class="dropdown-menu dropdown-menu-right" id="plusMenu"></ul>
</div>
<div id="search-input-wrap">
<form action="../../search.html" autocomplete="off" class="" method="get" role="search">
<div class="form-group inner-addon left-addon">
<i class="glyphicon glyphicon-search"></i>
<input class="form-control" name="q" placeholder="Search" type="text"/>
</div>
<input name="check_keywords" type="hidden" value="yes">
<input name="area" type="hidden" value="default"/>
</input></form>
<div id="search-preview"></div>
</div>
<div id="searchIcon">
<span aria-hidden="true" class="glyphicon glyphicon-search"></span>
</div>
<!-- <div id="lang-select-wrap"> -->
<!--   <label id="lang-select-label"> -->
<!--     <\!-- <i class="fa fa-globe"></i> -\-> -->
<!--     <span></span> -->
<!--   </label> -->
<!--   <select id="lang-select"> -->
<!--     <option value="en">Eng</option> -->
<!--     <option value="zh">中文</option> -->
<!--   </select> -->
<!-- </div> -->
<!--     <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a> -->
</div>
</div>
</div>
<div class="container">
<div class="row">
<div aria-label="main navigation" class="sphinxsidebar leftsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/index.html">Python Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/r/index.html">R Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/julia/index.html">Julia Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/c++/index.html">C++ Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/scala/index.html">Scala Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/perl/index.html">Perl Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to/index.html">HowTo Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/index.html">System Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorials</a></li>
</ul>
</div>
</div>
<div class="content">
<div class="section" id="handwritten-digits-classification-competition">
<span id="handwritten-digits-classification-competition"></span><h1>Handwritten Digits Classification Competition<a class="headerlink" href="#handwritten-digits-classification-competition" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://yann.lecun.com/exdb/mnist/">MNIST</a> is a handwritten digits image data set created by Yann LeCun. Every digit is represented by a 28 x 28 pixel image. It’s become a standard data set for testing classifiers on simple image input. A neural network is a strong model for image classification tasks. There’s a <a class="reference external" href="https://www.kaggle.com/c/digit-recognizer">long-term hosted competition</a> on Kaggle using this data set.
This tutorial shows how to use <a class="reference external" href="https://github.com/dmlc/mxnet/tree/master/R-package">MXNet</a> to compete in this challenge.</p>
<div class="section" id="loading-the-data">
<span id="loading-the-data"></span><h2>Loading the Data<a class="headerlink" href="#loading-the-data" title="Permalink to this headline">¶</a></h2>
<p>First, let’s download the data from <a class="reference external" href="https://www.kaggle.com/c/digit-recognizer/data">Kaggle</a> and put it in the <code class="docutils literal"><span class="pre">data/</span></code> folder in your working directory.</p>
<p>Now we can read it in R and convert it to matrices:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    <span class="kn">require</span><span class="p">(</span>mxnet<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## Loading required package: mxnet</span>
   <span class="c1">## Loading required package: methods</span>
</pre></div>
</div>
<div class="highlight-r"><div class="highlight"><pre><span></span>    train <span class="o"><-</span> read.csv<span class="p">(</span><span class="s">'data/train.csv'</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
    test <span class="o"><-</span> read.csv<span class="p">(</span><span class="s">'data/test.csv'</span><span class="p">,</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
    train <span class="o"><-</span> <span class="kp">data.matrix</span><span class="p">(</span>train<span class="p">)</span>
    test <span class="o"><-</span> <span class="kp">data.matrix</span><span class="p">(</span>test<span class="p">)</span>

    train.x <span class="o"><-</span> train<span class="p">[,</span><span class="m">-1</span><span class="p">]</span>
    train.y <span class="o"><-</span> train<span class="p">[,</span><span class="m">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Every image is represented as a single row in train/test. The greyscale of each image falls in the range [0, 255]. Linearly transform it into [0,1] by using the following command:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    train.x <span class="o"><-</span> <span class="kp">t</span><span class="p">(</span>train.x<span class="o">/</span><span class="m">255</span><span class="p">)</span>
    test <span class="o"><-</span> <span class="kp">t</span><span class="p">(</span>test<span class="o">/</span><span class="m">255</span><span class="p">)</span>
</pre></div>
</div>
<p>Transpose the input matrix to npixel x nexamples, which is the major format for columns accepted by MXNet (and the convention of R).</p>
<p>In the label section, the number of each digit is fairly evenly distributed:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    <span class="kp">table</span><span class="p">(</span>train.y<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## train.y</span>
   <span class="c1">##    0    1    2    3    4    5    6    7    8    9</span>
   <span class="c1">## 4132 4684 4177 4351 4072 3795 4137 4401 4063 4188</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-the-network">
<span id="configuring-the-network"></span><h2>Configuring the Network<a class="headerlink" href="#configuring-the-network" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the data, let’s configure the structure of our network:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    data <span class="o"><-</span> mx.symbol.Variable<span class="p">(</span><span class="s">"data"</span><span class="p">)</span>
    fc1 <span class="o"><-</span> mx.symbol.FullyConnected<span class="p">(</span>data<span class="p">,</span> name<span class="o">=</span><span class="s">"fc1"</span><span class="p">,</span> num_hidden<span class="o">=</span><span class="m">128</span><span class="p">)</span>
    act1 <span class="o"><-</span> mx.symbol.Activation<span class="p">(</span>fc1<span class="p">,</span> name<span class="o">=</span><span class="s">"relu1"</span><span class="p">,</span> act_type<span class="o">=</span><span class="s">"relu"</span><span class="p">)</span>
    fc2 <span class="o"><-</span> mx.symbol.FullyConnected<span class="p">(</span>act1<span class="p">,</span> name<span class="o">=</span><span class="s">"fc2"</span><span class="p">,</span> num_hidden<span class="o">=</span><span class="m">64</span><span class="p">)</span>
    act2 <span class="o"><-</span> mx.symbol.Activation<span class="p">(</span>fc2<span class="p">,</span> name<span class="o">=</span><span class="s">"relu2"</span><span class="p">,</span> act_type<span class="o">=</span><span class="s">"relu"</span><span class="p">)</span>
    fc3 <span class="o"><-</span> mx.symbol.FullyConnected<span class="p">(</span>act2<span class="p">,</span> name<span class="o">=</span><span class="s">"fc3"</span><span class="p">,</span> num_hidden<span class="o">=</span><span class="m">10</span><span class="p">)</span>
    softmax <span class="o"><-</span> mx.symbol.SoftmaxOutput<span class="p">(</span>fc3<span class="p">,</span> name<span class="o">=</span><span class="s">"sm"</span><span class="p">)</span>
</pre></div>
</div>
<ol class="simple">
<li>In <code class="docutils literal"><span class="pre">mxnet</span></code>, we use the data type <code class="docutils literal"><span class="pre">symbol</span></code> to configure the network. <code class="docutils literal"><span class="pre">data</span> <span class="pre"><-</span> <span class="pre">mx.symbol.Variable("data")</span></code> uses <code class="docutils literal"><span class="pre">data</span></code> to represent the input data, i.e., the input layer.</li>
<li>We set the first hidden layer with <code class="docutils literal"><span class="pre">fc1</span> <span class="pre"><-</span> <span class="pre">mx.symbol.FullyConnected(data,</span> <span class="pre">name="fc1",</span> <span class="pre">num_hidden=128)</span></code>. This layer has <code class="docutils literal"><span class="pre">data</span></code> as the input, its name, and the number of hidden neurons.</li>
<li>Activation is set with <code class="docutils literal"><span class="pre">act1</span> <span class="pre"><-</span> <span class="pre">mx.symbol.Activation(fc1,</span> <span class="pre">name="relu1",</span> <span class="pre">act_type="relu")</span></code>. The activation function takes the output from the first hidden layer, <code class="docutils literal"><span class="pre">fc1</span></code>.</li>
<li>The second hidden layer takes the result from <code class="docutils literal"><span class="pre">act1</span></code> as input, with its name as “fc2” and the number of hidden neurons as 64.</li>
<li>The second activation is almost the same as <code class="docutils literal"><span class="pre">act1</span></code>, except we have a different input source and name.</li>
<li>This generates the output layer. Because there are only 10 digits, we set the number of neurons to 10.</li>
<li>Finally, we set the activation to softmax to get a probabilistic prediction.</li>
</ol>
</div>
<div class="section" id="training">
<span id="training"></span><h2>Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h2>
<p>We are almost ready for the training process. Before we start the computation, let’s decide which device to use:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    devices <span class="o"><-</span> mx.cpu<span class="p">()</span>
</pre></div>
</div>
<p>We assign CPU to <code class="docutils literal"><span class="pre">mxnet</span></code>. Now, you can run the following command to train the neural network! Note that <code class="docutils literal"><span class="pre">mx.set.seed</span></code> is the function that controls the random process in <code class="docutils literal"><span class="pre">mxnet</span></code>:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    mx.set.seed<span class="p">(</span><span class="m">0</span><span class="p">)</span>
    model <span class="o"><-</span> mx.model.FeedForward.create<span class="p">(</span>softmax<span class="p">,</span> X<span class="o">=</span>train.x<span class="p">,</span> y<span class="o">=</span>train.y<span class="p">,</span>
                                         ctx<span class="o">=</span>devices<span class="p">,</span> num.round<span class="o">=</span><span class="m">10</span><span class="p">,</span> array.batch.size<span class="o">=</span><span class="m">100</span><span class="p">,</span>
                                         learning.rate<span class="o">=</span><span class="m">0.07</span><span class="p">,</span> momentum<span class="o">=</span><span class="m">0.9</span><span class="p">,</span>  eval.metric<span class="o">=</span>mx.metric.accuracy<span class="p">,</span>
                                         initializer<span class="o">=</span>mx.init.uniform<span class="p">(</span><span class="m">0.07</span><span class="p">),</span>
                                            epoch.end.callback<span class="o">=</span>mx.callback.log.train.metric<span class="p">(</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## Start training with 1 devices</span>
   <span class="c1">## Batch [100] Train-accuracy=0.6563</span>
   <span class="c1">## Batch [200] Train-accuracy=0.777999999999999</span>
   <span class="c1">## Batch [300] Train-accuracy=0.827466666666665</span>
   <span class="c1">## Batch [400] Train-accuracy=0.855499999999999</span>
   <span class="c1">## [1] Train-accuracy=0.859832935560859</span>
   <span class="c1">## Batch [100] Train-accuracy=0.9529</span>
   <span class="c1">## Batch [200] Train-accuracy=0.953049999999999</span>
   <span class="c1">## Batch [300] Train-accuracy=0.955866666666666</span>
   <span class="c1">## Batch [400] Train-accuracy=0.957525000000001</span>
   <span class="c1">## [2] Train-accuracy=0.958309523809525</span>
   <span class="c1">## Batch [100] Train-accuracy=0.968</span>
   <span class="c1">## Batch [200] Train-accuracy=0.9677</span>
   <span class="c1">## Batch [300] Train-accuracy=0.9696</span>
   <span class="c1">## Batch [400] Train-accuracy=0.970650000000002</span>
   <span class="c1">## [3] Train-accuracy=0.970809523809526</span>
   <span class="c1">## Batch [100] Train-accuracy=0.973</span>
   <span class="c1">## Batch [200] Train-accuracy=0.974249999999999</span>
   <span class="c1">## Batch [300] Train-accuracy=0.976</span>
   <span class="c1">## Batch [400] Train-accuracy=0.977100000000003</span>
   <span class="c1">## [4] Train-accuracy=0.977452380952384</span>
   <span class="c1">## Batch [100] Train-accuracy=0.9834</span>
   <span class="c1">## Batch [200] Train-accuracy=0.981949999999999</span>
   <span class="c1">## Batch [300] Train-accuracy=0.981900000000001</span>
   <span class="c1">## Batch [400] Train-accuracy=0.982600000000003</span>
   <span class="c1">## [5] Train-accuracy=0.983000000000003</span>
   <span class="c1">## Batch [100] Train-accuracy=0.983399999999999</span>
   <span class="c1">## Batch [200] Train-accuracy=0.98405</span>
   <span class="c1">## Batch [300] Train-accuracy=0.985000000000001</span>
   <span class="c1">## Batch [400] Train-accuracy=0.985725000000003</span>
   <span class="c1">## [6] Train-accuracy=0.985952380952384</span>
   <span class="c1">## Batch [100] Train-accuracy=0.988999999999999</span>
   <span class="c1">## Batch [200] Train-accuracy=0.9876</span>
   <span class="c1">## Batch [300] Train-accuracy=0.988100000000001</span>
   <span class="c1">## Batch [400] Train-accuracy=0.988750000000003</span>
   <span class="c1">## [7] Train-accuracy=0.988880952380955</span>
   <span class="c1">## Batch [100] Train-accuracy=0.991999999999999</span>
   <span class="c1">## Batch [200] Train-accuracy=0.9912</span>
   <span class="c1">## Batch [300] Train-accuracy=0.990066666666668</span>
   <span class="c1">## Batch [400] Train-accuracy=0.990275000000003</span>
   <span class="c1">## [8] Train-accuracy=0.990452380952384</span>
   <span class="c1">## Batch [100] Train-accuracy=0.9937</span>
   <span class="c1">## Batch [200] Train-accuracy=0.99235</span>
   <span class="c1">## Batch [300] Train-accuracy=0.991966666666668</span>
   <span class="c1">## Batch [400] Train-accuracy=0.991425000000003</span>
   <span class="c1">## [9] Train-accuracy=0.991500000000003</span>
   <span class="c1">## Batch [100] Train-accuracy=0.9942</span>
   <span class="c1">## Batch [200] Train-accuracy=0.99245</span>
   <span class="c1">## Batch [300] Train-accuracy=0.992433333333334</span>
   <span class="c1">## Batch [400] Train-accuracy=0.992275000000002</span>
   <span class="c1">## [10] Train-accuracy=0.992380952380955</span>
</pre></div>
</div>
</div>
<div class="section" id="making-a-prediction-and-submitting-to-the-competition">
<span id="making-a-prediction-and-submitting-to-the-competition"></span><h2>Making a Prediction and Submitting to the Competition<a class="headerlink" href="#making-a-prediction-and-submitting-to-the-competition" title="Permalink to this headline">¶</a></h2>
<p>To make a prediction, type:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    preds <span class="o"><-</span> predict<span class="p">(</span>model<span class="p">,</span> test<span class="p">)</span>
    <span class="kp">dim</span><span class="p">(</span>preds<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## [1]    10 28000</span>
</pre></div>
</div>
<p>It is a matrix with 28000 rows and 10 cols, containing the desired classification probabilities from the output layer. To extract the maximum label for each row, use <code class="docutils literal"><span class="pre">max.col</span></code>:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    pred.label <span class="o"><-</span> <span class="kp">max.col</span><span class="p">(</span><span class="kp">t</span><span class="p">(</span>preds<span class="p">))</span> <span class="o">-</span> <span class="m">1</span>
    <span class="kp">table</span><span class="p">(</span>pred.label<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## pred.label</span>
   <span class="c1">##    0    1    2    3    4    5    6    7    8    9</span>
   <span class="c1">## 2818 3195 2744 2767 2683 2596 2798 2790 2784 2825</span>
</pre></div>
</div>
<p>With a little extra effort to modify the .csv format, our submission is ready for the competition!</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    submission <span class="o"><-</span> <span class="kt">data.frame</span><span class="p">(</span>ImageId<span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="kp">ncol</span><span class="p">(</span>test<span class="p">),</span> Label<span class="o">=</span>pred.label<span class="p">)</span>
    write.csv<span class="p">(</span>submission<span class="p">,</span> file<span class="o">=</span><span class="s">'submission.csv'</span><span class="p">,</span> row.names<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span>  quote<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="lenet">
<span id="lenet"></span><h2>LeNet<a class="headerlink" href="#lenet" title="Permalink to this headline">¶</a></h2>
<p>Now let’s use a new network structure: <a class="reference external" href="http://yann.lecun.com/exdb/lenet/">LeNet</a>. It has been proposed by Yann LeCun for recognizing handwritten digits. We’ll demonstrate how to construct and train a LeNet in <code class="docutils literal"><span class="pre">mxnet</span></code>.</p>
<p>First, we construct the network:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span><span class="c1"># input</span>
data <span class="o"><-</span> mx.symbol.Variable<span class="p">(</span><span class="s">'data'</span><span class="p">)</span>
<span class="c1"># first conv</span>
conv1 <span class="o"><-</span> mx.symbol.Convolution<span class="p">(</span>data<span class="o">=</span>data<span class="p">,</span> kernel<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">5</span><span class="p">),</span> num_filter<span class="o">=</span><span class="m">20</span><span class="p">)</span>
tanh1 <span class="o"><-</span> mx.symbol.Activation<span class="p">(</span>data<span class="o">=</span>conv1<span class="p">,</span> act_type<span class="o">=</span><span class="s">"tanh"</span><span class="p">)</span>
pool1 <span class="o"><-</span> mx.symbol.Pooling<span class="p">(</span>data<span class="o">=</span>tanh1<span class="p">,</span> pool_type<span class="o">=</span><span class="s">"max"</span><span class="p">,</span>
                          kernel<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> stride<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># second conv</span>
conv2 <span class="o"><-</span> mx.symbol.Convolution<span class="p">(</span>data<span class="o">=</span>pool1<span class="p">,</span> kernel<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">5</span><span class="p">),</span> num_filter<span class="o">=</span><span class="m">50</span><span class="p">)</span>
tanh2 <span class="o"><-</span> mx.symbol.Activation<span class="p">(</span>data<span class="o">=</span>conv2<span class="p">,</span> act_type<span class="o">=</span><span class="s">"tanh"</span><span class="p">)</span>
pool2 <span class="o"><-</span> mx.symbol.Pooling<span class="p">(</span>data<span class="o">=</span>tanh2<span class="p">,</span> pool_type<span class="o">=</span><span class="s">"max"</span><span class="p">,</span>
                          kernel<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> stride<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># first fullc</span>
flatten <span class="o"><-</span> mx.symbol.Flatten<span class="p">(</span>data<span class="o">=</span>pool2<span class="p">)</span>
fc1 <span class="o"><-</span> mx.symbol.FullyConnected<span class="p">(</span>data<span class="o">=</span>flatten<span class="p">,</span> num_hidden<span class="o">=</span><span class="m">500</span><span class="p">)</span>
tanh3 <span class="o"><-</span> mx.symbol.Activation<span class="p">(</span>data<span class="o">=</span>fc1<span class="p">,</span> act_type<span class="o">=</span><span class="s">"tanh"</span><span class="p">)</span>
<span class="c1"># second fullc</span>
fc2 <span class="o"><-</span> mx.symbol.FullyConnected<span class="p">(</span>data<span class="o">=</span>tanh3<span class="p">,</span> num_hidden<span class="o">=</span><span class="m">10</span><span class="p">)</span>
<span class="c1"># loss</span>
lenet <span class="o"><-</span> mx.symbol.SoftmaxOutput<span class="p">(</span>data<span class="o">=</span>fc2<span class="p">)</span>
</pre></div>
</div>
<p>Then let’s reshape the matrices into arrays:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>train.array <span class="o"><-</span> train.x
<span class="kp">dim</span><span class="p">(</span>train.array<span class="p">)</span> <span class="o"><-</span> <span class="kt">c</span><span class="p">(</span><span class="m">28</span><span class="p">,</span> <span class="m">28</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="kp">ncol</span><span class="p">(</span>train.x<span class="p">))</span>
test.array <span class="o"><-</span> test
<span class="kp">dim</span><span class="p">(</span>test.array<span class="p">)</span> <span class="o"><-</span> <span class="kt">c</span><span class="p">(</span><span class="m">28</span><span class="p">,</span> <span class="m">28</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="kp">ncol</span><span class="p">(</span>test<span class="p">))</span>
</pre></div>
</div>
<p>We want to compare training speed on different devices, so define the devices:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>n.gpu <span class="o"><-</span> <span class="m">1</span>
device.cpu <span class="o"><-</span> mx.cpu<span class="p">()</span>
device.gpu <span class="o"><-</span> <span class="kp">lapply</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="p">(</span>n.gpu<span class="m">-1</span><span class="p">),</span> <span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span>
  mx.gpu<span class="p">(</span>i<span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>We can pass a list of devices to ask MXNet to train on multiple GPUs (you can do this for CPUs,
but because internal computation of CPUs is already multi-threaded, there is less gain than with using GPUs).</p>
<p>Start by training on the CPU first. Because this takes a bit time, we run it for just one iteration.</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    mx.set.seed<span class="p">(</span><span class="m">0</span><span class="p">)</span>
    tic <span class="o"><-</span> <span class="kp">proc.time</span><span class="p">()</span>
    model <span class="o"><-</span> mx.model.FeedForward.create<span class="p">(</span>lenet<span class="p">,</span> X<span class="o">=</span>train.array<span class="p">,</span> y<span class="o">=</span>train.y<span class="p">,</span>
                                     ctx<span class="o">=</span>device.cpu<span class="p">,</span> num.round<span class="o">=</span><span class="m">1</span><span class="p">,</span> array.batch.size<span class="o">=</span><span class="m">100</span><span class="p">,</span>
                                     learning.rate<span class="o">=</span><span class="m">0.05</span><span class="p">,</span> momentum<span class="o">=</span><span class="m">0.9</span><span class="p">,</span> wd<span class="o">=</span><span class="m">0.00001</span><span class="p">,</span>
                                     eval.metric<span class="o">=</span>mx.metric.accuracy<span class="p">,</span>
                                       epoch.end.callback<span class="o">=</span>mx.callback.log.train.metric<span class="p">(</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## Start training with 1 devices</span>
   <span class="c1">## Batch [100] Train-accuracy=0.1066</span>
   <span class="c1">## Batch [200] Train-accuracy=0.16495</span>
   <span class="c1">## Batch [300] Train-accuracy=0.401766666666667</span>
   <span class="c1">## Batch [400] Train-accuracy=0.537675</span>
   <span class="c1">## [1] Train-accuracy=0.557136038186157</span>
</pre></div>
</div>
<div class="highlight-r"><div class="highlight"><pre><span></span>    <span class="kp">print</span><span class="p">(</span><span class="kp">proc.time</span><span class="p">()</span> <span class="o">-</span> tic<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">##    user  system elapsed</span>
   <span class="c1">## 130.030 204.976  83.821</span>
</pre></div>
</div>
<p>Train on a GPU:</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    mx.set.seed<span class="p">(</span><span class="m">0</span><span class="p">)</span>
    tic <span class="o"><-</span> <span class="kp">proc.time</span><span class="p">()</span>
    model <span class="o"><-</span> mx.model.FeedForward.create<span class="p">(</span>lenet<span class="p">,</span> X<span class="o">=</span>train.array<span class="p">,</span> y<span class="o">=</span>train.y<span class="p">,</span>
                                     ctx<span class="o">=</span>device.gpu<span class="p">,</span> num.round<span class="o">=</span><span class="m">5</span><span class="p">,</span> array.batch.size<span class="o">=</span><span class="m">100</span><span class="p">,</span>
                                     learning.rate<span class="o">=</span><span class="m">0.05</span><span class="p">,</span> momentum<span class="o">=</span><span class="m">0.9</span><span class="p">,</span> wd<span class="o">=</span><span class="m">0.00001</span><span class="p">,</span>
                                     eval.metric<span class="o">=</span>mx.metric.accuracy<span class="p">,</span>
                                       epoch.end.callback<span class="o">=</span>mx.callback.log.train.metric<span class="p">(</span><span class="m">100</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">## Start training with 1 devices</span>
   <span class="c1">## Batch [100] Train-accuracy=0.1066</span>
   <span class="c1">## Batch [200] Train-accuracy=0.1596</span>
   <span class="c1">## Batch [300] Train-accuracy=0.3983</span>
   <span class="c1">## Batch [400] Train-accuracy=0.533975</span>
   <span class="c1">## [1] Train-accuracy=0.553532219570405</span>
   <span class="c1">## Batch [100] Train-accuracy=0.958</span>
   <span class="c1">## Batch [200] Train-accuracy=0.96155</span>
   <span class="c1">## Batch [300] Train-accuracy=0.966100000000001</span>
   <span class="c1">## Batch [400] Train-accuracy=0.968550000000003</span>
   <span class="c1">## [2] Train-accuracy=0.969071428571432</span>
   <span class="c1">## Batch [100] Train-accuracy=0.977</span>
   <span class="c1">## Batch [200] Train-accuracy=0.97715</span>
   <span class="c1">## Batch [300] Train-accuracy=0.979566666666668</span>
   <span class="c1">## Batch [400] Train-accuracy=0.980900000000003</span>
   <span class="c1">## [3] Train-accuracy=0.981309523809527</span>
   <span class="c1">## Batch [100] Train-accuracy=0.9853</span>
   <span class="c1">## Batch [200] Train-accuracy=0.985899999999999</span>
   <span class="c1">## Batch [300] Train-accuracy=0.986966666666668</span>
   <span class="c1">## Batch [400] Train-accuracy=0.988150000000002</span>
   <span class="c1">## [4] Train-accuracy=0.988452380952384</span>
   <span class="c1">## Batch [100] Train-accuracy=0.990199999999999</span>
   <span class="c1">## Batch [200] Train-accuracy=0.98995</span>
   <span class="c1">## Batch [300] Train-accuracy=0.990600000000001</span>
   <span class="c1">## Batch [400] Train-accuracy=0.991325000000002</span>
   <span class="c1">## [5] Train-accuracy=0.991523809523812</span>
</pre></div>
</div>
<div class="highlight-r"><div class="highlight"><pre><span></span>    <span class="kp">print</span><span class="p">(</span><span class="kp">proc.time</span><span class="p">()</span> <span class="o">-</span> tic<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>   <span class="c1">##    user  system elapsed</span>
   <span class="c1">##   9.288   1.680   6.889</span>
</pre></div>
</div>
<p>By using a GPU processor, we significantly speed up training!
Now, we can submit the result to Kaggle to see the improvement of our ranking!</p>
<div class="highlight-r"><div class="highlight"><pre><span></span>    preds <span class="o"><-</span> predict<span class="p">(</span>model<span class="p">,</span> test.array<span class="p">)</span>
    pred.label <span class="o"><-</span> <span class="kp">max.col</span><span class="p">(</span><span class="kp">t</span><span class="p">(</span>preds<span class="p">))</span> <span class="o">-</span> <span class="m">1</span>
    submission <span class="o"><-</span> <span class="kt">data.frame</span><span class="p">(</span>ImageId<span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="kp">ncol</span><span class="p">(</span>test<span class="p">),</span> Label<span class="o">=</span>pred.label<span class="p">)</span>
    write.csv<span class="p">(</span>submission<span class="p">,</span> file<span class="o">=</span><span class="s">'submission.csv'</span><span class="p">,</span> row.names<span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> quote<span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="tutorials/r/../../web-data/mxnet/knitr/mnistCompetition-kaggle-submission.png"/></p>
</div>
<div class="section" id="next-steps">
<span id="next-steps"></span><h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference external" href="http://mxnet.io/tutorials/r/charRnnModel.html">Character Language Model using RNN</a></li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="footer">
<p> © 2015-2017 DMLC. All rights reserved. </p>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar rightsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li><a class="reference internal" href="#">Handwritten Digits Classification Competition</a><ul>
<li><a class="reference internal" href="#loading-the-data">Loading the Data</a></li>
<li><a class="reference internal" href="#configuring-the-network">Configuring the Network</a></li>
<li><a class="reference internal" href="#training">Training</a></li>
<li><a class="reference internal" href="#making-a-prediction-and-submitting-to-the-competition">Making a Prediction and Submitting to the Competition</a></li>
<li><a class="reference internal" href="#lenet">LeNet</a></li>
<li><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div> <!-- pagename != index -->
<script crossorigin="anonymous" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="../../_static/js/sidebar.js" type="text/javascript"></script>
<script src="../../_static/js/search.js" type="text/javascript"></script>
<script src="../../_static/js/navbar.js" type="text/javascript"></script>
<script src="../../_static/js/clipboard.min.js" type="text/javascript"></script>
<script src="../../_static/js/copycode.js" type="text/javascript"></script>
<script type="text/javascript">
        $('body').ready(function () {
            $('body').css('visibility', 'visible');
        });
    </script>
</div></body>
</html>